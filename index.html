<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>My first multiplayer game</title> <!-- main code from https://phaser.io/tutorials/making-your-first-phaser-3-game/part1 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var stars;
var bombs;
var platforms;
var cursors;
var gameOver = false;
var players = []

var config = {
  players: 4,
  type: Phaser.AUTO,
  width: 800,
  height: 600,
  block_width: 32,
  block_height: 48,

  physics: {
      default: 'arcade',
      arcade: {
          gravity: { y: 300 },
          debug: false
      }
  },
  scene: {
      preload: preload,
      create: create,
      update: update
  }
};

let Player = class {

  constructor(player_number, sprites)
  {
    this.player_number = player_number
    this.score = 0;
    sprites.load.spritesheet('player' + player_number, 'assets/player' + this.player_number + '.png', { frameWidth: 32, frameHeight: 48 });
  }

  setup(phaser_object)
  {
    this.player = phaser_object.physics.add.sprite(100, 450, 'player' + this.player_number);
    this.player.setBounce(0.2);
    this.player.setCollideWorldBounds(true);
    
    this.player.anims.create({
        key: 'left',
        frames: this.player.anims.generateFrameNumbers('player' + this.player_number, { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.player.anims.create({
        key: 'turn',
        frames: [ { key: 'player' + this.player_number, frame: 4 } ],
        frameRate: 20
    });

    this.player.anims.create({
        key: 'right',
        frames: this.player.anims.generateFrameNumbers('player' + this.player_number, { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });

    if (this.player_number == 0)
    {
      cursors = phaser_object.input.keyboard.createCursorKeys();
      this.left = cursors.left
      this.right = cursors.right
      this.up = cursors.up
      this.scoreText = phaser_object.add.text(16, 16,this.player_number + ': 0', { fontSize: '32px', fill: '#000' });
    }

    if (this.player_number == 1)
    {
      this.left = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
      this.right = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
      this.up = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
      this.scoreText = phaser_object.add.text(400, 16, this.player_number + ': 0', { fontSize: '32px', fill: '#000' });
    }

    if (this.player_number == 2)
    {
      this.left = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.F);
      this.right = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.H);
      this.up = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.T);
      this.scoreText = phaser_object.add.text(16, 46, this.player_number + ': 0', { fontSize: '32px', fill: '#000' });
    }

    if(this.player_number == 3)
    {
      this.left = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.J);
      this.right = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.L);
      this.up = phaser_object.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.I);
      this.scoreText = phaser_object.add.text(400, 46, this.player_number + ': 0', { fontSize: '32px', fill: '#000' });
    }
  
  }

  setup_collisions(platforms, stars, bombs, phaser_object)
  {
    phaser_object.physics.add.collider(this.player, platforms);
    phaser_object.physics.add.overlap(this.player, stars, this.collectStar, null, phaser_object);
    phaser_object.physics.add.collider(this.player, bombs, this.hitBomb, null, phaser_object);

    for (let player_no = 0; player_no < config.players; player_no++)
    {
      if (player_no != this.player_number) // player collisions with eachother
      {
        phaser_object.physics.add.collider(this.player, players[player_no].player);
      }
    }
  }

  go_left()
  {
    this.player.setVelocityX(-160);
    this.player.anims.play('left', true);
  }

  go_right()
  {
    this.player.setVelocityX(160);
    this.player.anims.play('right', true);
  }

  turn()
  {
    this.player.setVelocityX(0);
    this.player.anims.play('turn');
  }

  jump()
  {
    this.player.setVelocityY(-330);
  }


  collectStar(stars, bombs) 
  {
    stars.disableBody(true, true);

    this.score += 10;

    if (stars.countActive(true) === 0)
    {
      //  A new batch of stars to collect
      stars.children.iterate(function (child) {

        child.enableBody(true, child.x, 0, true, true);

      });

      //var x = (this.player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

      var bomb = bombs.create(29, 16, 'bomb');
      bomb.setBounce(1);
      bomb.setCollideWorldBounds(true);
      bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
      bomb.allowGravity = false;

    }
  }

  hitBomb (bomb)
  {
      this.physics.pause();
      this.player.setTint(0xff0000);
      this.player.anims.play('turn');
      gameOver = true;
  }
};


var game = new Phaser.Game(config);

function preload ()
{

  for (let player_no = 0; player_no < config.players; player_no++)
  {
    players.push(new Player(player_no, this))
  }

  this.load.image('sky', 'assets/sky.png');
  this.load.image('ground', 'assets/platform.png');
  this.load.image('star', 'assets/star.png');
  this.load.image('bomb', 'assets/bomb.png');
}

function create ()
{
  this.add.image(400, 300, 'sky');  //  A simple background for our game
  platforms = this.physics.add.staticGroup();
  platforms.create(400, 568, 'ground').setScale(2).refreshBody(); // ground
  platforms.create(600, 400, 'ground'); //ledges
  platforms.create(50, 250, 'ground');
  platforms.create(750, 220, 'ground');

  for (let player_no = 0; player_no < config.players; player_no++)
  {
    players[player_no].setup(this);
  }

  stars = this.physics.add.group({
      key: 'star',
      repeat: 11,
      setXY: { x: 12, y: 0, stepX: 70 }
  });

  stars.children.iterate(function (child) {

      child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

  });

  bombs = this.physics.add.group();

  // collisions
  for (let player_no = 0; player_no < config.players; player_no++)
  {
    players[player_no].setup_collisions(platforms, stars, bombs, this);
  }

  this.physics.add.collider(stars, platforms);    
  this.physics.add.collider(bombs, platforms);
}

function update ()
{
  if (gameOver)
  {
      return;
  }

  for (let player_no = 0; player_no < config.players; player_no++)
  {
    if (players[player_no].left.isDown)
    {
      players[player_no].go_left()
    }
    else if (players[player_no].right.isDown)
    {
      players[player_no].go_right()
    }
    else
    {
      players[player_no].turn()
    }
    
    if (players[player_no].up.isDown  && players[player_no].player.body.touching.down)
    {
      players[player_no].jump()
    }
  }
}

</script>

</body>
</html>